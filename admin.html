<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×ª×•×›×Ÿ - ××“××™×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #f3f4f6; }
        .card { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="p-8">

    <header class="mb-8 flex justify-between items-center bg-white p-6 rounded-xl shadow-sm">
        <h1 class="text-3xl font-bold text-gray-800">× ×™×”×•×œ ×ª×›× ×™ ×”×’×Ÿ ğŸ› ï¸</h1>
        <button onclick="saveAllToGithub()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 transition">
            ×©××•×¨ ×•×¢×“×›×Ÿ ××ª ×›×œ ×”×’× ×™× (GitHub)
        </button>
    </header>

    <section class="mb-8 card border-2 border-blue-200">
        <h2 class="text-xl font-bold mb-4">×”×’×“×¨×•×ª ×¡× ×›×¨×•×Ÿ</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input type="password" id="ghToken" placeholder="GitHub Personal Token" class="border p-2 rounded text-left">
            <input type="text" id="ghRepo" placeholder="Username/RepoName" class="border p-2 rounded text-left">
            <input type="text" id="ghPath" placeholder="path/to/manual_links.json" class="border p-2 rounded text-left">
        </div>
        <p class="text-xs text-gray-500 mt-2">* ×”×˜×•×§×Ÿ × ×©××¨ ×¨×§ ×‘×“×¤×“×¤×Ÿ ×©×œ×š ×›×¨×’×¢.</p>
    </section>

    <div id="editorContainer" class="space-y-8">
        </div>

    <script>
        let fullData = {};

        // 1. ×˜×¢×™× ×ª ×”× ×ª×•× ×™× ×”×§×™×™××™× (××”-JSON ×”× ×•×›×—×™)
        async function loadData() {
            try {
                const response = await fetch('manual_links.json');
                fullData = await response.json();
                renderEditor();
            } catch (e) {
                console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥", e);
            }
        }

        // 2. ×”×¦×’×ª ×”×××©×§ ×œ×¢×¨×™×›×”
        function renderEditor() {
            const container = document.getElementById('editorContainer');
            container.innerHTML = '';

            for (const [category, items] of Object.entries(fullData)) {
                let catHtml = `
                    <div class="bg-gray-200 p-6 rounded-xl shadow-inner">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-blue-800">×§×˜×’×•×¨×™×”: ${category}</h2>
                            <button onclick="addItem('${category}')" class="bg-blue-600 text-white px-4 py-1 rounded-full text-sm font-bold">+ ×”×•×¡×£ ×©×™×¨</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;

                items.forEach((item, index) => {
                    catHtml += `
                        <div class="card space-y-3 relative">
                            <button onclick="removeItem('${category}', ${index})" class="absolute top-2 left-2 text-red-500 font-bold">X</button>
                            <div>
                                <label class="block text-xs font-bold text-gray-500">×›×•×ª×¨×ª:</label>
                                <input type="text" value="${item.title}" onchange="updateItem('${category}', ${index}, 'title', this.value)" class="w-full border p-1 rounded">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500">Embed URL:</label>
                                <input type="text" value="${item.url}" onchange="updateItem('${category}', ${index}, 'url', this.value)" class="w-full border p-1 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500">××¢×¨×š ×©×™×¢×•×¨:</label>
                                <textarea onchange="updateItem('${category}', ${index}, 'lesson_plan', this.value)" class="w-full border p-1 rounded h-20 text-sm">${item.lesson_plan || ''}</textarea>
                            </div>
                        </div>
                    `;
                });

                catHtml += `</div></div>`;
                container.innerHTML += catHtml;
            }
        }

        // ×¤×•× ×§×¦×™×•×ª ×¢×¨×™×›×” ××§×•××™×•×ª
        function updateItem(cat, idx, field, val) { fullData[cat][idx][field] = val; }
        function removeItem(cat, idx) { fullData[cat].splice(idx, 1); renderEditor(); }
        function addItem(cat) { 
            fullData[cat].push({ title: "×©×™×¨ ×—×“×©", url: "", lesson_plan: "" }); 
            renderEditor(); 
        }

        // 3. ×©××™×¨×” ×œ-GitHub API
        async function saveAllToGithub() {
            const token = document.getElementById('ghToken').value;
            const repo = document.getElementById('ghRepo').value;
            const path = document.getElementById('ghPath').value;

            if (!token || !repo || !path) {
                alert("×× × ××œ× ××ª ×¤×¨×˜×™ ×”-GitHub (×˜×•×§×Ÿ, ×××’×¨ ×•× ×ª×™×‘)");
                return;
            }

            try {
                // ×. ×§×‘×œ×ª ×”-SHA ×©×œ ×”×§×•×‘×¥ ×”×§×™×™× (×—×•×‘×” ×‘-GitHub API)
                const getFileResponse = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                const fileData = await getFileResponse.json();
                const sha = fileData.sha;

                // ×‘. ×©×œ×™×—×ª ×”×¢×“×›×•×Ÿ
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(fullData, null, 2))));
                const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: "Update kindergarten content from Admin Dashboard",
                        content: content,
                        sha: sha
                    })
                });

                if (updateResponse.ok) {
                    alert("âœ… ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”! ×”×“×£ ×©×œ ×”×’× × ×•×ª ×™×ª×¢×“×›×Ÿ ×ª×•×š ×›×“×§×”.");
                } else {
                    alert("âŒ ×©×’×™××” ×‘×©××™×¨×” ×œ-GitHub.");
                }
            } catch (e) {
                console.error(e);
                alert("×©×’×™××” ×‘×ª×”×œ×™×š ×”×©××™×¨×”.");
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>
